<!doctype html>
<html>
    <head>
        <style>
            .dynamic-row label {
                font-weight: bold;
                margin-left: 8px;
                margin-right: 4px;
            }
        </style>
    </head>
    <body>
        <h1>Hello world</h1>
        <form id="foo">
            <div id="wrapper"></div>
            <br/>
            <input type="submit"></input>
        </form>
        <script src="js/jquery.min.js"></script>
        <script>
            function generateDynamicRow(parentId, columnDataList, rowIndex) {
                var $row = $("<li>").addClass('dynamic-row');

                for (var colIndex=0; colIndex < columnDataList.length; colIndex++) {
                    var columnData = columnDataList[colIndex];
                    var colType = columnData.type;
                    var colLabel = columnData.label || '';
                    var colId = columnData.id || '';
                    var uniqueId = [parentId, colId, ''+rowIndex].join("__");

                    var $colLabel = $("<label>").text(colLabel);
                    $row.append($colLabel);

                    if (colType == 'text') {
                        $colLabel.addClass('text-label');
                        var $input = $("<input>").attr({
                            type: "text",
                            name: uniqueId
                        }).appendTo($row);
                    } else if (colType == 'dropdown') {
                        $colLabel.addClass('dropdown-label');
                        var dropdownId = uniqueId;
                        var options = columnData.options || [];

                        // START: copied from generateFormContent, 
                        // should probably call existing _makeDropdown function
                        var $optionWrapper = $('<div>')
                            .addClass('col-xs-4')
                            .addClass('col-xs-offset-1');
                        var $dropdownSelect = $('<select>')
                            .attr({
                                id: dropdownId,
                                name: dropdownId
                            })
                            .addClass('form-control')
                            .appendTo($optionWrapper);

                        for (var i=0; i < options.length; i++) {
                            var optionData = options[i];
                            var optText = optionData.value || '';
                            var optId = optionData.id || '';

                            var $option = $('<option>')
                                .text(optText)
                                .attr('value', optId);
                            $dropdownSelect.append($option);
                        }
                        // END: copied from generateFormContent

                        $dropdownSelect.appendTo($row);
                    }


                }

                return $row;
            }


            function generateDynamicControl(text, id, data) {
                var $title = $("<h2>").addClass('title').text(text);
                var $container = $("<ol>").addClass('dynamic-row-container');

                var columnDataList = data.columns || [];
                var numRows = 0;
                var _addRowFn = function() {
                    $container.append(
                        generateDynamicRow(id, columnDataList, numRows)
                    );
                    numRows++;
                };

                var $addButton = $("<button>").text('Add new row');
                $addButton.click(function(e) {
                    e.preventDefault();
                    _addRowFn();
                });

                // Also populate with one empty row
                _addRowFn();

                return [$title, $container, $addButton];
            }


            window.onload = function() {
                var data = {
                    "type":"dynamic-row",
                    "question":"Household info",
                    "id":"household",
                    "columns": [
                        {
                            "type": "dropdown",
                            "label": "Gender",
                            "id": "gender",
                            "options": [
                                {
                                    "id": "male",
                                    "value": "Male"
                                },
                                {
                                    "id": "female",
                                    "value": "Female"
                                }
                            ]
                        },
                        {
                            "type": "text",
                            "label": "Foo",
                            "id": "foo"
                        }
                    ]
                };



                var $form = $('#foo');
                var $container = $form.find("#wrapper");
                $container.append(generateDynamicControl(
                    data.question,
                    data.id,
                    data
                ));

                $form.on('submit', function(e) {
                    e.preventDefault();

                    var $serialized = $form.serializeArray();
                    console.log($serialized);
                    alert(JSON.stringify($serialized));
                });
            }
        </script>
    </body>
</html>
